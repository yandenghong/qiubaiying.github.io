---
layout:     post
title:      蓄水池抽样算法的python实现
date:       2019-04-18
author:     yandenghong
header-img: img/post-bg-universe.jpg
catalog: true
tags:
    - 算法
    - Python
---
## 问题
给定一个数据流，数据流长度N很大，且N直到处理完所有数据之前都不可知，请问如何在只遍历一遍数据（O(N)）的情况下，能够随机选取出m个不重复的数据。

## 解决
```python
import random


class Reservoir:
    """
    蓄水池抽样算法
    """
    # 蓄水池
    pool = list()
    # 用于存储接收数据的次数
    index = 0

    def __init__(self, pool_capacity: int):
        """
        :param pool_capacity: 蓄水池的容量
        """
        self.pool_capacity = pool_capacity

    def receive_data(self, data: str or int):
        """
        接收数据并抽样存储到数据池
        :param data: 接收的数据
        """
        if data is not None and data not in self.pool:
            # 如果池子满了
            if self.index >= self.pool_capacity:
                # 从接收到的数据中随机取一个
                d = random.randint(0, self.index)
                # 如果该数据在池中则用新接收到的数据替换
                if d in range(0, self.pool_capacity):
                    self.pool[d] = data
            else:
                self.pool.append(data)
        self.index += 1


def push_dataset():
    # 定义一个蓄水池容量为10的抽样器
    res = Reservoir(10)
    # 模拟接收100个数据
    for i in range(100):
        data = random.randint(0, 5000)
        res.receive_data(data)
        print("第{}次接收到的数据是: {} 此时的蓄水池: {}".format(i+1, data, res.pool))


if __name__ == '__main__':
    push_dataset()

```

以上代码的运行结果:
```text
第1次接收到的数据是: 1047 此时的蓄水池: [1047]
第2次接收到的数据是: 1152 此时的蓄水池: [1047, 1152]
第3次接收到的数据是: 4334 此时的蓄水池: [1047, 1152, 4334]
第4次接收到的数据是: 2029 此时的蓄水池: [1047, 1152, 4334, 2029]
第5次接收到的数据是: 4903 此时的蓄水池: [1047, 1152, 4334, 2029, 4903]
第6次接收到的数据是: 267 此时的蓄水池: [1047, 1152, 4334, 2029, 4903, 267]
第7次接收到的数据是: 3211 此时的蓄水池: [1047, 1152, 4334, 2029, 4903, 267, 3211]
第8次接收到的数据是: 4136 此时的蓄水池: [1047, 1152, 4334, 2029, 4903, 267, 3211, 4136]
第9次接收到的数据是: 3332 此时的蓄水池: [1047, 1152, 4334, 2029, 4903, 267, 3211, 4136, 3332]
第10次接收到的数据是: 1177 此时的蓄水池: [1047, 1152, 4334, 2029, 4903, 267, 3211, 4136, 3332, 1177]
第11次接收到的数据是: 1179 此时的蓄水池: [1047, 1152, 4334, 2029, 4903, 267, 3211, 4136, 3332, 1179]
第12次接收到的数据是: 2061 此时的蓄水池: [1047, 1152, 4334, 2029, 2061, 267, 3211, 4136, 3332, 1179]
第13次接收到的数据是: 2277 此时的蓄水池: [1047, 1152, 4334, 2277, 2061, 267, 3211, 4136, 3332, 1179]
第14次接收到的数据是: 1270 此时的蓄水池: [1047, 1152, 4334, 2277, 2061, 267, 3211, 4136, 3332, 1270]
第15次接收到的数据是: 195 此时的蓄水池: [1047, 1152, 4334, 2277, 2061, 267, 3211, 195, 3332, 1270]
第16次接收到的数据是: 4755 此时的蓄水池: [1047, 1152, 4334, 4755, 2061, 267, 3211, 195, 3332, 1270]
第17次接收到的数据是: 495 此时的蓄水池: [1047, 1152, 4334, 4755, 2061, 267, 3211, 195, 3332, 1270]
第18次接收到的数据是: 2111 此时的蓄水池: [1047, 1152, 4334, 4755, 2061, 267, 2111, 195, 3332, 1270]
第19次接收到的数据是: 1202 此时的蓄水池: [1047, 1152, 4334, 4755, 2061, 267, 2111, 195, 3332, 1270]
第20次接收到的数据是: 134 此时的蓄水池: [1047, 1152, 4334, 4755, 2061, 267, 2111, 195, 3332, 1270]
第21次接收到的数据是: 3428 此时的蓄水池: [1047, 1152, 3428, 4755, 2061, 267, 2111, 195, 3332, 1270]
第22次接收到的数据是: 1378 此时的蓄水池: [1047, 1152, 3428, 4755, 2061, 267, 2111, 195, 1378, 1270]
第23次接收到的数据是: 1999 此时的蓄水池: [1047, 1999, 3428, 4755, 2061, 267, 2111, 195, 1378, 1270]
第24次接收到的数据是: 908 此时的蓄水池: [1047, 1999, 3428, 4755, 2061, 267, 2111, 908, 1378, 1270]
第25次接收到的数据是: 3829 此时的蓄水池: [1047, 1999, 3428, 4755, 2061, 267, 2111, 908, 3829, 1270]
第26次接收到的数据是: 2862 此时的蓄水池: [1047, 1999, 3428, 4755, 2061, 2862, 2111, 908, 3829, 1270]
第27次接收到的数据是: 3614 此时的蓄水池: [1047, 1999, 3614, 4755, 2061, 2862, 2111, 908, 3829, 1270]
第28次接收到的数据是: 1901 此时的蓄水池: [1047, 1999, 3614, 4755, 2061, 2862, 2111, 908, 3829, 1270]
第29次接收到的数据是: 3310 此时的蓄水池: [1047, 1999, 3614, 4755, 2061, 2862, 2111, 908, 3829, 1270]
第30次接收到的数据是: 3349 此时的蓄水池: [1047, 1999, 3614, 4755, 2061, 2862, 3349, 908, 3829, 1270]
第31次接收到的数据是: 3108 此时的蓄水池: [1047, 1999, 3614, 4755, 2061, 2862, 3349, 908, 3829, 1270]
第32次接收到的数据是: 4708 此时的蓄水池: [1047, 1999, 3614, 4755, 2061, 2862, 3349, 908, 3829, 1270]
第33次接收到的数据是: 4177 此时的蓄水池: [1047, 1999, 3614, 4755, 2061, 2862, 3349, 908, 3829, 1270]
第34次接收到的数据是: 3217 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 908, 3829, 1270]
第35次接收到的数据是: 367 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 367, 3829, 1270]
第36次接收到的数据是: 3855 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 367, 3829, 1270]
第37次接收到的数据是: 2790 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 367, 3829, 1270]
第38次接收到的数据是: 4562 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 367, 3829, 1270]
第39次接收到的数据是: 2877 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 367, 3829, 1270]
第40次接收到的数据是: 431 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第41次接收到的数据是: 2627 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第42次接收到的数据是: 1256 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第43次接收到的数据是: 970 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第44次接收到的数据是: 3614 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第45次接收到的数据是: 1005 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第46次接收到的数据是: 2771 此时的蓄水池: [1047, 1999, 3614, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第47次接收到的数据是: 1199 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第48次接收到的数据是: 4249 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第49次接收到的数据是: 2491 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第50次接收到的数据是: 3055 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第51次接收到的数据是: 4813 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第52次接收到的数据是: 3537 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 3349, 431, 3829, 1270]
第53次接收到的数据是: 4110 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第54次接收到的数据是: 450 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第55次接收到的数据是: 3665 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第56次接收到的数据是: 4575 此时的蓄水池: [1047, 1999, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第57次接收到的数据是: 4676 此时的蓄水池: [4676, 1999, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第58次接收到的数据是: 938 此时的蓄水池: [4676, 1999, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第59次接收到的数据是: 3200 此时的蓄水池: [4676, 1999, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第60次接收到的数据是: 17 此时的蓄水池: [4676, 1999, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第61次接收到的数据是: 1090 此时的蓄水池: [4676, 1090, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第62次接收到的数据是: 3062 此时的蓄水池: [4676, 1090, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第63次接收到的数据是: 4845 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第64次接收到的数据是: 1308 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第65次接收到的数据是: 690 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第66次接收到的数据是: 4061 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第67次接收到的数据是: 1889 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第68次接收到的数据是: 147 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第69次接收到的数据是: 1533 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第70次接收到的数据是: 205 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第71次接收到的数据是: 628 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第72次接收到的数据是: 1951 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第73次接收到的数据是: 2960 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第74次接收到的数据是: 1038 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第75次接收到的数据是: 2549 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第76次接收到的数据是: 1092 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第77次接收到的数据是: 1939 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第78次接收到的数据是: 892 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1270]
第79次接收到的数据是: 1340 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第80次接收到的数据是: 4789 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第81次接收到的数据是: 4406 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第82次接收到的数据是: 3275 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第83次接收到的数据是: 3188 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第84次接收到的数据是: 4009 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第85次接收到的数据是: 1561 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第86次接收到的数据是: 1513 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第87次接收到的数据是: 3126 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第88次接收到的数据是: 4209 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第89次接收到的数据是: 1346 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第90次接收到的数据是: 3176 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第91次接收到的数据是: 2150 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第92次接收到的数据是: 458 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第93次接收到的数据是: 2482 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第94次接收到的数据是: 2960 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第95次接收到的数据是: 4786 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第96次接收到的数据是: 3571 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第97次接收到的数据是: 4196 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第98次接收到的数据是: 2546 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第99次接收到的数据是: 3020 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
第100次接收到的数据是: 1493 此时的蓄水池: [4676, 4845, 1199, 4755, 3217, 2862, 4110, 431, 3829, 1340]
```
